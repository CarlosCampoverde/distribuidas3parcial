version: '3.8'

# =====================================================
# LogiFlow - Microservices Platform
# Docker Compose Configuration
# =====================================================

networks:
  logiflow-network:
    driver: bridge

volumes:
  authdb-data:
  pedidodb-data:
  fleetdb-data:
  billingdb-data:
  rabbitmq-data:
  pgadmin-data:

services:
  # =====================================================
  # DATABASES
  # =====================================================
  
  authdb:
    image: postgres:15-alpine
    container_name: logiflow-authdb
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: logiuser
      POSTGRES_PASSWORD: logipass123
    ports:
      - "5532:5432"
    volumes:
      - authdb-data:/var/lib/postgresql/data
    networks:
      - logiflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logiuser -d authdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  pedidodb:
    image: postgres:15-alpine
    container_name: logiflow-pedidodb
    environment:
      POSTGRES_DB: pedidodb
      POSTGRES_USER: logiuser
      POSTGRES_PASSWORD: logipass123
    ports:
      - "5533:5432"
    volumes:
      - pedidodb-data:/var/lib/postgresql/data
    networks:
      - logiflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logiuser -d pedidodb"]
      interval: 10s
      timeout: 5s
      retries: 5

  fleetdb:
    image: postgres:15-alpine
    container_name: logiflow-fleetdb
    environment:
      POSTGRES_DB: fleetdb
      POSTGRES_USER: logiuser
      POSTGRES_PASSWORD: logipass123
    ports:
      - "5534:5432"
    volumes:
      - fleetdb-data:/var/lib/postgresql/data
    networks:
      - logiflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logiuser -d fleetdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  billingdb:
    image: postgres:15-alpine
    container_name: logiflow-billingdb
    environment:
      POSTGRES_DB: billingdb
      POSTGRES_USER: logiuser
      POSTGRES_PASSWORD: logipass123
    ports:
      - "5535:5432"
    volumes:
      - billingdb-data:/var/lib/postgresql/data
    networks:
      - logiflow-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logiuser -d billingdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # MESSAGE BROKER
  # =====================================================
  
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: logiflow-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: logiflow
      RABBITMQ_DEFAULT_PASS: logiflow123
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - logiflow-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # DATABASE MANAGEMENT
  # =====================================================
  
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: logiflow-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@logiflow.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - logiflow-network
    depends_on:
      - authdb
      - pedidodb
      - fleetdb
      - billingdb

  # =====================================================
  # MICROSERVICES
  # =====================================================
  
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: logiflow-auth-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://authdb:5432/authdb
      SPRING_DATASOURCE_USERNAME: logiuser
      SPRING_DATASOURCE_PASSWORD: logipass123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: logiflow-super-secret-key-for-jwt-tokens-2024-production
      JWT_EXPIRATION: 86400000
    ports:
      - "8081:8081"
    networks:
      - logiflow-network
    depends_on:
      authdb:
        condition: service_healthy
    restart: unless-stopped

  pedido-service:
    build:
      context: .
      dockerfile: pedido-service/Dockerfile
    container_name: logiflow-pedido-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://pedidodb:5432/pedidodb
      SPRING_DATASOURCE_USERNAME: logiuser
      SPRING_DATASOURCE_PASSWORD: logipass123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: logiflow
      SPRING_RABBITMQ_PASSWORD: logiflow123
    ports:
      - "8082:8082"
    networks:
      - logiflow-network
    depends_on:
      pedidodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  fleet-service:
    build:
      context: .
      dockerfile: fleet-service/Dockerfile
    container_name: logiflow-fleet-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://fleetdb:5432/fleetdb
      SPRING_DATASOURCE_USERNAME: logiuser
      SPRING_DATASOURCE_PASSWORD: logipass123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: logiflow
      SPRING_RABBITMQ_PASSWORD: logiflow123
    ports:
      - "8083:8083"
    networks:
      - logiflow-network
    depends_on:
      fleetdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  billing-service:
    build:
      context: .
      dockerfile: billing-service/Dockerfile
    container_name: logiflow-billing-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://billingdb:5432/billingdb
      SPRING_DATASOURCE_USERNAME: logiuser
      SPRING_DATASOURCE_PASSWORD: logipass123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    ports:
      - "8084:8084"
    networks:
      - logiflow-network
    depends_on:
      billingdb:
        condition: service_healthy
    restart: unless-stopped

  graphql-service:
    build:
      context: .
      dockerfile: graphql-service/Dockerfile
    container_name: logiflow-graphql-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      PEDIDO_SERVICE_URL: http://pedido-service:8082
      FLEET_SERVICE_URL: http://fleet-service:8083
      BILLING_SERVICE_URL: http://billing-service:8084
    ports:
      - "8085:8085"
    networks:
      - logiflow-network
    depends_on:
      - pedido-service
      - fleet-service
      - billing-service
    restart: unless-stopped

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: logiflow-notification-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: logiflow
      SPRING_RABBITMQ_PASSWORD: logiflow123
    ports:
      - "8086:8086"
    networks:
      - logiflow-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: logiflow-api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      AUTH_SERVICE_URL: http://auth-service:8081
      PEDIDO_SERVICE_URL: http://pedido-service:8082
      FLEET_SERVICE_URL: http://fleet-service:8083
      BILLING_SERVICE_URL: http://billing-service:8084
      GRAPHQL_SERVICE_URL: http://graphql-service:8085
      NOTIFICATION_SERVICE_URL: http://notification-service:8086
      JWT_SECRET: logiflow-super-secret-key-for-jwt-tokens-2024-production
    ports:
      - "8080:8080"
    networks:
      - logiflow-network
    depends_on:
      - auth-service
      - pedido-service
      - fleet-service
      - billing-service
      - graphql-service
      - notification-service
    restart: unless-stopped
